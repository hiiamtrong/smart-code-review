#!/usr/bin/env bash
set -e

# AI Review CLI Tool
VERSION="1.0.5"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Paths
CONFIG_DIR="$HOME/.config/ai-review"
CONFIG_FILE="$CONFIG_DIR/config"
HOOKS_DIR="$CONFIG_DIR/hooks"
HOOK_SCRIPT="$HOOKS_DIR/pre-commit.sh"

# Hook marker to identify our hook
HOOK_MARKER="# AI-REVIEW-HOOK"

# ============================================
# Helper Functions
# ============================================

log_error() {
  echo -e "${RED}[ERROR]${NC} $1" >&2
}

log_success() {
  echo -e "${GREEN}[OK]${NC} $1"
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

log_info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

check_git_repo() {
  if ! git rev-parse --is-inside-work-tree &> /dev/null; then
    log_error "Not a git repository"
    exit 1
  fi
}

check_config_exists() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "Configuration not found"
    echo "Run 'ai-review setup' to configure credentials"
    exit 1
  fi
}

get_git_hooks_dir() {
  git rev-parse --git-dir 2>/dev/null | xargs -I {} echo "{}/hooks"
}

# ============================================
# Commands
# ============================================

cmd_setup() {
  echo -e "${BOLD}AI Review Setup${NC}"
  echo ""

  # Create config directory if needed
  mkdir -p "$CONFIG_DIR"

  # Load existing values if config exists
  local OLD_URL="" OLD_KEY="" OLD_MODEL="" OLD_PROVIDER=""
  if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE" 2>/dev/null || true
    OLD_URL="$AI_GATEWAY_URL"
    OLD_KEY="$AI_GATEWAY_API_KEY"
    OLD_MODEL="$AI_MODEL"
    OLD_PROVIDER="$AI_PROVIDER"

    log_warn "Configuration already exists"
    read -p "Do you want to overwrite it? [y/N]: " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
      echo "Setup cancelled"
      exit 0
    fi
    echo ""
    log_info "Press Enter to keep existing value"
  fi

  echo "Please provide your AI Gateway credentials:"
  echo ""

  # AI Gateway URL
  if [[ -n "$OLD_URL" ]]; then
    read -p "Enter AI Gateway URL [$OLD_URL]: " AI_GATEWAY_URL
    AI_GATEWAY_URL="${AI_GATEWAY_URL:-$OLD_URL}"
  else
    read -p "Enter AI Gateway URL: " AI_GATEWAY_URL
    while [[ -z "$AI_GATEWAY_URL" ]]; do
      log_error "URL is required"
      read -p "Enter AI Gateway URL: " AI_GATEWAY_URL
    done
  fi

  # AI Gateway API Key
  if [[ -n "$OLD_KEY" ]]; then
    local masked_key="${OLD_KEY:0:4}****${OLD_KEY: -4}"
    read -sp "Enter AI Gateway API Key [$masked_key]: " AI_GATEWAY_API_KEY
    echo ""
    AI_GATEWAY_API_KEY="${AI_GATEWAY_API_KEY:-$OLD_KEY}"
  else
    read -sp "Enter AI Gateway API Key: " AI_GATEWAY_API_KEY
    echo ""
    while [[ -z "$AI_GATEWAY_API_KEY" ]]; do
      log_error "API Key is required"
      read -sp "Enter AI Gateway API Key: " AI_GATEWAY_API_KEY
      echo ""
    done
  fi

  # AI Model (optional)
  local default_model="${OLD_MODEL:-gemini-2.0-flash}"
  read -p "Enter AI Model [$default_model]: " AI_MODEL
  AI_MODEL="${AI_MODEL:-$default_model}"

  # AI Provider (optional)
  local default_provider="${OLD_PROVIDER:-google}"
  read -p "Enter AI Provider [$default_provider]: " AI_PROVIDER
  AI_PROVIDER="${AI_PROVIDER:-$default_provider}"

  # Save config
  cat > "$CONFIG_FILE" << EOF
# AI Review Configuration
# Generated by ai-review setup on $(date)

AI_GATEWAY_URL="$AI_GATEWAY_URL"
AI_GATEWAY_API_KEY="$AI_GATEWAY_API_KEY"
AI_MODEL="$AI_MODEL"
AI_PROVIDER="$AI_PROVIDER"
EOF

  chmod 600 "$CONFIG_FILE"

  echo ""
  log_success "Configuration saved to $CONFIG_FILE"
  echo ""
  echo "Next steps:"
  echo "  1. Navigate to a git repository"
  echo "  2. Run: ai-review install"
}

cmd_install() {
  check_git_repo
  check_config_exists

  local hooks_dir=$(get_git_hooks_dir)
  local target_hook="$hooks_dir/pre-commit"
  local original_hook="$hooks_dir/pre-commit.original"

  log_info "Installing AI Review hook..."

  # Create hooks directory if needed
  mkdir -p "$hooks_dir"

  # Check if hook already exists
  if [[ -f "$target_hook" ]]; then
    if grep -q "$HOOK_MARKER" "$target_hook" 2>/dev/null; then
      log_warn "AI Review hook is already installed"
      read -p "Do you want to reinstall? [y/N]: " confirm
      if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Aborted"
        exit 0
      fi
      # Keep original hook if it exists
    else
      # Existing hook is not ours - save it to chain
      log_warn "A pre-commit hook already exists"
      echo "Current hook: $target_hook"
      echo ""
      echo "Options:"
      echo "  1) Chain hooks - run existing hook first, then AI review"
      echo "  2) Replace - backup existing and use AI review only"
      echo "  3) Cancel"
      echo ""
      read -p "Choose option [1/2/3]: " choice
      case "$choice" in
        1)
          # Save original hook for chaining
          mv "$target_hook" "$original_hook"
          chmod +x "$original_hook"
          log_info "Saved original hook for chaining"
          ;;
        2)
          # Backup and replace
          cp "$target_hook" "$target_hook.backup"
          log_info "Backed up existing hook to $target_hook.backup"
          ;;
        *)
          echo "Aborted"
          exit 0
          ;;
      esac
    fi
  fi

  # Create the hook as a wrapper
  if [[ -f "$original_hook" ]]; then
    # Chain mode - run original hook first, then AI review
    cat > "$target_hook" << EOF
#!/usr/bin/env bash
$HOOK_MARKER
# This hook was installed by ai-review (chain mode)
# It runs the original hook first, then AI review
# To uninstall, run: ai-review uninstall

# Run original pre-commit hook first
if [[ -x "$original_hook" ]]; then
  "$original_hook" "\$@"
  ORIGINAL_EXIT=\$?
  if [[ \$ORIGINAL_EXIT -ne 0 ]]; then
    echo ""
    echo "Original pre-commit hook failed (exit code: \$ORIGINAL_EXIT)"
    exit \$ORIGINAL_EXIT
  fi
fi

# Then run AI review
exec "$HOOK_SCRIPT" "\$@"
EOF
    log_info "Installed in chain mode (original hook runs first)"
  else
    # Standalone mode
    cat > "$target_hook" << EOF
#!/usr/bin/env bash
$HOOK_MARKER
# This hook was installed by ai-review
# To uninstall, run: ai-review uninstall

exec "$HOOK_SCRIPT" "\$@"
EOF
  fi

  chmod +x "$target_hook"

  log_success "AI Review hook installed"
  echo ""
  echo "The hook will now run on every commit."
  echo "To bypass: git commit --no-verify"
}

cmd_uninstall() {
  check_git_repo

  local hooks_dir=$(get_git_hooks_dir)
  local target_hook="$hooks_dir/pre-commit"
  local original_hook="$hooks_dir/pre-commit.original"

  log_info "Uninstalling AI Review hook..."

  if [[ ! -f "$target_hook" ]]; then
    log_warn "No pre-commit hook found"
    exit 0
  fi

  # Check if it's our hook
  if ! grep -q "$HOOK_MARKER" "$target_hook" 2>/dev/null; then
    log_error "The existing pre-commit hook is not an AI Review hook"
    echo "Please remove it manually if needed: $target_hook"
    exit 1
  fi

  rm "$target_hook"
  log_success "AI Review hook removed"

  # Restore original hook if exists (from chain mode)
  if [[ -f "$original_hook" ]]; then
    mv "$original_hook" "$target_hook"
    log_success "Original pre-commit hook restored"
  # Or restore backup if exists (from replace mode)
  elif [[ -f "$target_hook.backup" ]]; then
    read -p "Restore previous hook from backup? [y/N]: " confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
      mv "$target_hook.backup" "$target_hook"
      log_success "Previous hook restored from backup"
    fi
  fi
}

cmd_config() {
  local action="${1:-show}"

  case "$action" in
    show)
      if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "No configuration found"
        echo "Run 'ai-review setup' to configure"
        exit 1
      fi

      echo -e "${BOLD}AI Review Configuration${NC}"
      echo "Location: $CONFIG_FILE"
      echo ""

      # Load and display config (mask API key)
      while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue

        # Remove quotes from value
        value=$(echo "$value" | sed 's/^"//;s/"$//')

        # Mask API key
        if [[ "$key" == "AI_GATEWAY_API_KEY" ]]; then
          if [[ ${#value} -gt 8 ]]; then
            masked="${value:0:4}...${value: -4}"
          else
            masked="****"
          fi
          echo "  $key: $masked"
        else
          echo "  $key: $value"
        fi
      done < "$CONFIG_FILE"
      ;;

    set)
      local key="$2"
      local value="$3"

      if [[ -z "$key" || -z "$value" ]]; then
        log_error "Usage: ai-review config set KEY VALUE"
        exit 1
      fi

      check_config_exists

      # Update or add the key
      if grep -q "^$key=" "$CONFIG_FILE"; then
        sed -i.bak "s|^$key=.*|$key=\"$value\"|" "$CONFIG_FILE"
        rm -f "$CONFIG_FILE.bak"
      else
        echo "$key=\"$value\"" >> "$CONFIG_FILE"
      fi

      log_success "Updated $key"
      ;;

    edit)
      if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "No configuration found"
        exit 1
      fi

      # Open in default editor
      ${EDITOR:-vi} "$CONFIG_FILE"
      ;;

    *)
      log_error "Unknown config action: $action"
      echo "Usage: ai-review config [show|set|edit]"
      exit 1
      ;;
  esac
}

cmd_status() {
  echo -e "${BOLD}AI Review Status${NC}"
  echo ""

  # Version
  echo "Version: $VERSION"
  echo ""

  # Config status
  echo "Configuration:"
  if [[ -f "$CONFIG_FILE" ]]; then
    log_success "Config exists at $CONFIG_FILE"

    # Check required values
    source "$CONFIG_FILE" 2>/dev/null || true
    if [[ -n "$AI_GATEWAY_URL" ]]; then
      echo "  Gateway URL: $AI_GATEWAY_URL"
    else
      log_warn "AI_GATEWAY_URL not set"
    fi

    if [[ -n "$AI_GATEWAY_API_KEY" ]]; then
      echo "  API Key: ****"
    else
      log_warn "AI_GATEWAY_API_KEY not set"
    fi
  else
    log_error "Config not found at $CONFIG_FILE"
    echo "  Run 'ai-review setup' to configure"
  fi
  echo ""

  # Hook script status
  echo "Hook Script:"
  if [[ -f "$HOOK_SCRIPT" ]]; then
    log_success "Hook script installed at $HOOK_SCRIPT"
  else
    log_error "Hook script not found at $HOOK_SCRIPT"
  fi
  echo ""

  # Current repo status
  echo "Current Repository:"
  if git rev-parse --is-inside-work-tree &> /dev/null; then
    local hooks_dir=$(get_git_hooks_dir)
    local target_hook="$hooks_dir/pre-commit"

    echo "  Repo: $(basename $(git rev-parse --show-toplevel))"

    if [[ -f "$target_hook" ]]; then
      if grep -q "$HOOK_MARKER" "$target_hook" 2>/dev/null; then
        log_success "AI Review hook is installed"
      else
        log_warn "Pre-commit hook exists but is not AI Review"
      fi
    else
      log_info "No pre-commit hook installed"
      echo "  Run 'ai-review install' to enable"
    fi
  else
    log_info "Not in a git repository"
  fi
}

cmd_diff() {
  check_git_repo

  local show_cached=true
  local show_path=true

  # Parse options
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --all|-a)
        show_cached=false
        ;;
      --no-path)
        show_path=false
        ;;
      *)
        ;;
    esac
    shift
  done

  local SHOWLINENUM="$HOOKS_DIR/showlinenum.awk"

  # Check if showlinenum.awk exists
  if [[ ! -f "$SHOWLINENUM" ]]; then
    log_warn "showlinenum.awk not found, downloading..."
    local REPO_URL="https://raw.githubusercontent.com/hiiamtrong/smart-code-review/main"
    curl -sSL "$REPO_URL/scripts/showlinenum.awk" -o "$SHOWLINENUM"
    chmod +x "$SHOWLINENUM"
  fi

  # Get diff with line numbers
  local diff_opts=""
  if [[ "$show_cached" == true ]]; then
    diff_opts="--cached"
  fi

  local awk_opts="show_header=0"
  if [[ "$show_path" == true ]]; then
    awk_opts="$awk_opts show_path=1"
  fi

  # Requires gawk (GNU awk) for gensub() function
  if ! command -v gawk &>/dev/null; then
    log_error "gawk (GNU awk) is required but not found"
    echo ""
    echo "Install gawk:"
    echo "  macOS:  brew install gawk"
    echo "  Ubuntu: sudo apt-get install gawk"
    exit 1
  fi

  git diff --color=always $diff_opts | gawk -f "$SHOWLINENUM" $awk_opts
}

cmd_update() {
  log_info "Updating AI Review..."

  # Download latest versions
  local REPO_URL="https://raw.githubusercontent.com/hiiamtrong/smart-code-review/main"
  local BIN_DIR="$HOME/.local/bin"

  # Update CLI
  echo "Downloading latest CLI..."
  if curl -sSL "$REPO_URL/scripts/local/ai-review" -o "$BIN_DIR/ai-review.new"; then
    mv "$BIN_DIR/ai-review.new" "$BIN_DIR/ai-review"
    chmod +x "$BIN_DIR/ai-review"
    log_success "CLI updated"
  else
    log_error "Failed to download CLI"
    rm -f "$BIN_DIR/ai-review.new"
    exit 1
  fi

  # Update hook script
  echo "Downloading latest hook script..."
  if curl -sSL "$REPO_URL/scripts/local/pre-commit.sh" -o "$HOOK_SCRIPT.new"; then
    mv "$HOOK_SCRIPT.new" "$HOOK_SCRIPT"
    chmod +x "$HOOK_SCRIPT"
    log_success "Hook script updated"
  else
    log_error "Failed to download hook script"
    rm -f "$HOOK_SCRIPT.new"
    exit 1
  fi

  # Update showlinenum.awk
  echo "Downloading showlinenum.awk..."
  if curl -sSL "$REPO_URL/scripts/showlinenum.awk" -o "$HOOKS_DIR/showlinenum.awk.new"; then
    mv "$HOOKS_DIR/showlinenum.awk.new" "$HOOKS_DIR/showlinenum.awk"
    chmod +x "$HOOKS_DIR/showlinenum.awk"
    log_success "showlinenum.awk updated"
  else
    log_warn "Failed to download showlinenum.awk (optional)"
    rm -f "$HOOKS_DIR/showlinenum.awk.new"
  fi

  echo ""
  log_success "Update complete!"
  echo "New version: $(ai-review --version 2>/dev/null || echo 'unknown')"
}

cmd_help() {
  cat << EOF
${BOLD}AI Review CLI${NC} - AI-powered code review for git commits

${YELLOW}USAGE:${NC}
    ai-review <command> [options]

${YELLOW}COMMANDS:${NC}
    setup         Configure AI Gateway credentials (interactive)
    install       Install AI Review hook in the current repository
    uninstall     Remove AI Review hook from the current repository
    config        View or modify configuration
                  - ai-review config           Show current config
                  - ai-review config set K V   Set a config value
                  - ai-review config edit      Open config in editor
    diff          Show staged diff with line numbers
                  - ai-review diff             Show staged changes
                  - ai-review diff --all       Show all changes (not just staged)
                  - ai-review diff --no-path   Hide file paths
    status        Show installation and configuration status
    update        Update AI Review to the latest version
    help          Show this help message

${YELLOW}OPTIONS:${NC}
    --version     Show version number

${YELLOW}EXAMPLES:${NC}
    ai-review setup                      # Configure credentials
    ai-review install                    # Enable AI review for current repo
    ai-review config set AI_MODEL gpt-4  # Change AI model
    ai-review status                     # Check if everything is set up

${YELLOW}BYPASSING:${NC}
    To skip AI review for a single commit:
    git commit --no-verify -m "message"

${YELLOW}MORE INFO:${NC}
    Config location: $CONFIG_FILE
    Hook location:   $HOOK_SCRIPT

EOF
}

# ============================================
# Main
# ============================================

main() {
  local command="${1:-help}"
  shift || true

  case "$command" in
    setup)
      cmd_setup "$@"
      ;;
    install)
      cmd_install "$@"
      ;;
    uninstall)
      cmd_uninstall "$@"
      ;;
    config)
      cmd_config "$@"
      ;;
    status)
      cmd_status "$@"
      ;;
    update)
      cmd_update "$@"
      ;;
    diff)
      cmd_diff "$@"
      ;;
    help|--help|-h)
      cmd_help
      ;;
    --version|-v)
      echo "ai-review version $VERSION"
      ;;
    *)
      log_error "Unknown command: $command"
      echo "Run 'ai-review help' for usage"
      exit 1
      ;;
  esac
}

main "$@"
